var vine = require('vine')                                                    

exports.plugin = function(router) {

	router.on({
		
		/**!  
		 * Posts status message to one or more target accounts
		 * @accounts the accounts separated by "+", or the service type (twitter, facebook, linkedin)
		 * @collection accounts
		 * @displayName postStatusUpdate 
		 */
		
	   	'pull \
	   	-method=POST \
	   	feed/identify/post:*:wall -> \
	   		accounts/:accounts/post': function(req, res) {    
	   	                            
			var running = 1, api = vine.api();
			
			var onPosted = function() {           
			  
				if(!(--running)) api.result(1).end(res);
			}         
			                  
			req.identifiedFeeds.forEach(function(feed) {     
			                
				running++;
				                
				feed.target.load({ account: feed.account, status: feed.data.status }, function(err, response) { 
				                            
					if(err) {

						api.error('Unable to post to %s account %s', feed.service, feed.account.displayName);
					} else {
						//api.result('')     
					}
					
					onPosted();
				});         
			});
			   
			//call to deprecate running if it's 1 (no idenfified feeds)                           
			onPosted();
		}
	});
}