var loadRequest = require('psk/node/io/net').loadRequest,
URLRequest = require('psk/node/io/net').Request;

exports.plugin = function(router)
{
	function getSocialService(req, res)
	{                 
		var info = 
		{
			name:'Sna.pr'
			,type:'graph'
			,service: new (function(params)
			{				
				var host = 'https://api.sna.pr/';

				function load(uri, data, callback)
				{
					var request = new URLRequest(host+uri);
					request.data = data;

					loadRequest(request, function (data)
					{
						try
						{
							callback(JSON.parse(data));
						}
						catch(e)
						{
							callback(null);
						}
					}) 
				}

				this.search = function(q,callback)
				{
					load('search/',{keywords:q},function(data)
					{
						callback(data ? data.response.photos : null)
					})
				}
			}
			)()
			,loaders:
			{
				photos:
				{
					search: 
					{
						name:'Photo Search'    
						,params:{q:{type:'input'}}
						,renderData:function(data)
						{
							var small = ' http://media-server'+data.server_id+'.snapr.us/sml/'+data.secret+'/'+data.id+'.jpg'
							var large = ' http://media-server'+data.server_id+'.snapr.us/lrg/'+data.secret+'/'+data.id+'.jpg'

							var nd = {
								type:'image'
								,text:data.description
								,createdAt:new Date(data.date)
								,media:[{
									type:'image'
									,link:large
									,regular:{link:small}
								}]
								,
								augment:false
							}

							return nd;
						}// ,ignoreMedia:true  
						,ignoreMedia:true
						,identify:
						{
							test:[/sna.pr\/search\/#(\w+)/]
							,feed:function(match,callback)
							{
								callback(false, {q:match[1]});
							}
						}
						,load:function(data,callback)
						{
							this.service.search(data.q,function(data)
							{
								callback(!data,data);
							})    
						}
					}

				}	
			}
		}


		info.loaders.default = info.loaders.photos;

		res.end(info)
	}	
	
	router.on({
		'collect social/service': getSocialService
	})
}