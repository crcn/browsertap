var net = require('psk/node/io/net'), 
	URLRequest = net.Request,
	load = net.loadRequest;

//http://www.flickr.com/services/rest?jsonSubscribeback=jsonp1290879037077&format=json&api_key=2a56884b56a00758525eaa2fee16a798&method=flickr.photos.getInfo&photo_id=5211389456                                                       
var Flickr = function(apiKey,apiSecret)
{     
	var host = 'http://www.flickr.com/services/rest';
	 
	function sendRequest(method,params,secret,callback)
	{                 
		params.api_key = apiKey;
		params.method = method;    
		params.format = 'json';
		params.jsonSubscribeback = '';
		
	    if(secret)	params.secret = apiSecret;
		
		
		var req = new URLRequest(host);
			req.data = params;
		
		load(req,function(buffer)
		{
			//stupid yahoo architects proved a javascript callback >.>   
			try
			{            
				var matches = buffer.match(/^jsonFlickrApi\((.*?)\)\s*$/);
				return callback(JSON.parse(matches[1]));
			}catch(e)
			{
				console.error(e.stack.toString());
			} 
			                  
			callback(null);
		});
		                                                                       
	}  
	
	
	this.getPhotoUrl = function(id,callback)
	{
		this.getPhotoInfo(id,function(info)
		{   
			if(!info) return callback(null);                                                                                                                    
			var p = info.photo;                       
			callback('http://farm'+p.farm+'.static.flickr.com/'+p.server+'/'+p.id+'_'+p.secret+'.jpg')
		});
	} 
	
	this.getPhotoInfo = function(id,callback)
	{
		sendRequest('flickr.photos.getInfo',{photo_id:id},false,function(info)
		{                       
			callback(info);
		});
	}
	
	this.searchPhoto = function(search,callback)
	{
		sendRequest('flickr.photos.search',search,false,function(info)
		{                       
			callback(info);
		});
	}  

}        

exports.Flickr = Flickr;