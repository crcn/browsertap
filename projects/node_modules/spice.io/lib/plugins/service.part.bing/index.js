var renderFeedData = require('./render').feedData;

exports.plugin = function(mediator)
{
	function getSocialService(req, res)
	{
		var searchBing = 
		{
			name:'Bing Search'
			,params:{q:{type:'input'}}
			,renderData:renderFeedData
			,load: function(data, callback)
			{

				this.service.search(data.q, function(feed)
				{ 
					if(!feed) return callback(true);

					callback(false,feed.channels[0].items);
				}); 
			}
		}
	
	
	
		var info = 
		{
			name:'Bing'
			,type:'graph'
			,service: new (function()
			{
				this.search = function(keyword,callback)
				{
					feed.load('feed://www.bing.com/search?q='+keyword+'&format=rss',callback);
				}

				this.searchNews = function(keyword,callback)
				{
					feed.load('feed://api.bing.com/rss.aspx?Source=News&Market=en-US&Version=2.0&Query='+keyword,callback)
				}

				}),
			loaders:
			{
				default:
				{
					search:searchBing
				}
				,engine:
				{
					search:searchBing
				}
				,news:
				{
					search:
					{
						name:'News Search'
						,params:{q:{type:'input'}}
						,renderData:renderFeedData
						,load:function(data,callback)
						{
							this.service.searchNews(data.q,function(feed)
							{
								if(!feed) return callback(true);
								callback(false,feed.channels[0].items);
							});
						}
					}
				}
			}
		}
	
		res.end(info);	
	}
	
	mediator.on({
		'collect social/service': getSocialService
	})
}
