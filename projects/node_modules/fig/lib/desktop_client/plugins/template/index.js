var logger = require('mesh-winston').loggers.get('fig');

exports.plugin = function(router)
{
    var cache = {};

	router.on({

		/**
		 */

		'pull -hook template OR template/:name': function(req, res, mw)
		{                         
            var name = mw.data('name');


            logger.debug('loading template: ' + name);

            if(cache[name]) {
                logger.debug('template is cached, returning');
                return res.end(cache[name]);
            }

            var onTemplate = function(content)
            {
                logger.debug('template '+name+' loaded');
                cache[name] = content;

                res.end(content);
            }

            var hash = (typeof mesh != 'undefined' ? mesh.buildId : null) || Date.now();

            
            var ops = {
                url: name + '?'+ hash,
                dataType: 'application/html',
                success: function(content)
                {
                     req.template = content;
                    
                    if(!mw.next())
                    {
                        onTemplate(content);
                    }
                },
                error: function(e)
                {
                    onTemplate(e.responseText);
                }
            }
            
            $.ajax(ops);

		}
	});
}