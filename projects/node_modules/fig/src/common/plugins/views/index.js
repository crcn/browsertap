var ViewChain = require('./viewChain'),
logger = require('mesh-winston').loggers.get('views.core');
  
/** 
 * caches the views for front-end applications
 */


exports.plugin = function(router) {


    var rootView,
    rootViewPath,  
    rootViewChain,
	rootViewClass,
	serverSide = typeof window == "undefined";

	function getRootViewChain(view) {
		if(view && view.__viewChain) return view.__viewChain;

		var viewChain = new ViewChain();

		if(!view) view = rootViewClass ? new rootViewClass() : null;
		if(view) view.__viewChain = viewChain;

		viewChain.view = view;

		return viewChain;
	}

    
    router.on({

    	/**
    	 */

    	'pull load/*': function(req, res, mw) {
    		
    		logger.verbose('loading views');


    		//a root view is essential incase the root changes for any reason.
    		//for example - displaying a page over ANOTHER pager, which would be a HUD.
    		router.on('push -pull root/view', function(viewClass) {
    			
    			logger.verbose('set root view');

				rootViewClass = viewClass;
				rootViewChain = getRootViewChain();

				mw.next();
    		});
    	},


    	/**
    	 * overridable
    	 */

    	'pull -priority=-999 root/view': function(req, res) {
    		res.end(null);
    	},
    
		/**
		 */

        'pull view': function(req, res, mw) {


			var crootViewChain = rootViewChain;// = rootViewChain = rootViewChain || getRootViewChain();


			//override the current root view - useful for HUDS and such...
			if(req.query.root) {

				crootViewChain = getRootViewChain(req.query.root);
				
			} else {

				if(!rootViewChain) rootViewChain = getRootViewChain();

				crootViewChain = rootViewChain;
			}
            
            //get the path name of the view we're about to hit e.g: view -> dashboard
            var viewPath = mw.router.parse.stringifySegments(mw.current.getNextSibling().path.segments, mw.params),
            nextChain;

            logger.debug('view path: ' + viewPath);


                        

			//if we're running server-side, it's a new view chain each time. However, client-side - we cache. And for every
			//middleware item we pass through, we make sure that we're not replacing views which are already present. Much Faster.

			/*if(req.viewChain) {
				nextChain = req.viewChain.next(req, res, viewPath);
			} else {
				nextChain = serverSide ? getRootViewChain() : crootViewChain;
				nextChain.apply(req, res, viewPath);
			}*/

			//if we're running server-side, it's a new view chain each time. However, client-side - we cache. And for every
			//middleware item we pass through, we make sure that we're not replacing views which are already present. Much Faster.
            nextChain = req.viewChain = (req.viewChain || (serverSide ? getRootViewChain() : crootViewChain)).next(req, res, viewPath);

			// req.viewChain = nextChain;
                                    
			//view exists? This could be something like the home page. Skip it.
			if(nextChain.view) {                             
            	logger.info(viewPath + ' is already visible, skipping next');	
                                 
				//skip the next path
				mw.skipNext();  
			} else {
				logger.debug('moving onto the next path');
           		mw.next();
			}
        }
    });
}