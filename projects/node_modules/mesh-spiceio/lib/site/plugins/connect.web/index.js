
exports.openWindow = function(url, title, width, height)
{
	window.open(url, title,"width="+width+",height="+height+",left="+(screen.width/2-width/2)+",top="+(screen.height/2-height/2));
}


exports.plugin = function(router)
{

	var profile, host, defaultRedirect;
	
	router.on({
		
		/**
		 */

		'pull malt -> connect/:service OR connect/:in/:service': function(req, res, mw)
		{
			var serviceName = req.params.service,
			redirect = req.query.redirect || defaultRedirect || window.location.pathname;

			var connectUrl = 'http://' + host + '/connect/'+ serviceName + '?r=' + Math.random() + '&redirect='+ escape('http://'+window.location.host +'/connected/'+Math.random());

			//link up the accounts IF logged in
			if(profile)
			{
				connectUrl += '&accessToken=' + profile.doc.accessToken;
			}
			
            if(req.params['in'])
            {

            	//redirects after connected
                if(redirect) router.push('store', { path: 'connect/redirect', data: redirect });

                window.location = connectUrl;
            }
            else
            {
                //open the connection window
                exports.openWindow(connectUrl, 'Connect', 800, 600);
            }
            
			var self = this;

			//setup the callback 
			window.authorizedConnect = function(prof)
			{
				window.authorizedConnect = undefined;

				router.push('rawProfile', { profile: prof, redirect: redirect });
			}
		},

		/**
		 */
		
		'push connect/redirect': function(value)
		{
			defaultRedirect = value;
		},

		/**
		 */

 		'push rawProfile': function(data)
 		{

			profile = new router.models.Profile(data.profile);
				
			router.push('store', { path: 'store/profile', data: profile });

			router.push('redirect', data.redirect || defaultRedirect);
 		},

		/**
		 */

		'push host': function(newHost)
		{
			host = newHost;
		},


		'push -pull store/profile': function(prof) {

			if(prof && prof.doc && prof.doc.accessToken) {

				function logout() {
					router.push('store',{ path : 'store/profile', data: null });
		 			router.push('store/profile', null);
					// return router.push('rawProfile', { redirect: 'login?redirect_to=' + window.location.pathname });
					return router.push('redirect','login?redirect_to=' + window.location.pathname);
				}


				var newProf = new router.models.Profile({ accessToken: String(prof.doc.accessToken) });

				newProf.load(function(err) {
					console.log(err);
					if(err) logout();
				})	
				
			}
		}
	});
}